<!DOCTYPE html>
<html>

<head>
        <meta name="viewport" content="initial-scale=0.4,user-scalable=no">
        <link href="https://fonts.googleapis.com/css?family=Press+Start+2P&display=swap" rel="stylesheet">

        <!-- firebase -->
        <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-database.js"></script>

        <title>Battle of the Elements</title>
        <style type="text/css">
                body {
                        background-color: black;
                        overscroll-behavior: contain;
                }

                canvas {
                        border: 5px solid red;
                }

                .upbtn {
                        position: fixed;
                        left: 200px;
                        background: white;
                        top: 800px;
                        width: 150px;
                        height: 150px; 
                }
                .downbtn {
                        position: fixed;
                        left: 200px;
                        background: white;
                        top: 1200px;
                        width: 150px;
                        height: 150px;       
                }
                .leftbtn {
                        position: fixed;
                        left: 1px;
                        background: white;
                        top: 1000px;
                        width: 150px;
                        height: 150px;       
                }
                .rightbtn {
                        position: fixed;
                        left: 400px;
                        background: white;
                        top: 1000px;
                        width: 150px;
                        height: 150px;       
                }
                .abtna, .bbtnb {
                        margin-left: 15px;
                        font-family: 'Press Start 2P', cursive;
                        margin-top: 245px; 
                        font-size: 125px;
                }
                .abtn {
                        position: fixed;
                        left: 600px;
                        background: darkslategrey;;
                        top: 800px;
                        width: 150px;
                        height: 600px;       
                }
                .bbtn {
                        position: fixed;
                        left: 800px;
                        background: darkslategrey;
                        top: 800px;
                        width: 150px;
                        height: 600px;       
                }
                #fireBtn {
                        border-radius: 100px;
                        position: fixed;
                        left: 455px;
                        background: red;
                        top: 800px;
                        width: 120px;
                        height: 120px;       
                }
                #waterBtn {
                        border-radius: 100px;
                        position: fixed;
                        left: 455px;
                        background: blue;
                        top: 957px;
                        width: 120px;
                        height: 120px;       
                }
                #earthBtn {
                        border-radius: 100px;
                        position: fixed;
                        left: 455px;
                        background: rgba(165, 42, 42, 0.473);
                        top: 1117px;
                        width: 120px;
                        height: 120px;       
                }
                #airBtn {
                        border-radius: 100px;
                        position: fixed;
                        left: 455px;
                        background: white;
                        top: 1277px;
                        width: 120px;
                        height: 120px;       
                }
                /* .btn {
                        font-size: 100px;
                        text-align: center;
                } */
                .joystickContainer {
                        position: fixed;
                        width: 350px;
                        height: 350px;
                        left: 80px;
                        background: lime;
                        top: 800px;
                }
                #joystick {
                        width: 350px;
                        height: 350px;
                        border: 1px dashed white;
                }

                .dev-opts {
                        position: fixed;
                        bottom: 0px;
                        width: 100%;
                        height: 200px;
                }
                .dev-btn {
                        width: 200px;
                        height: 200px;
                        background: whitesmoke;
                        font-size: 50px;
                        color: lime;
                }
        </style>
</head>

<body id="bod">

        <div align="center">
                <canvas id="canvas" width="1000px" height="700px"></canvas>                
                <!-- <button id="updateBtn" style="background: lime; color: black; font-size: 30px;">update location</button>
                <button id="connectBtn" style="background: magenta; font-size: 30px">connect</button>
                <button id="disconnectBtn" style="background: red; font-size: 30px">disconnect</button> -->
                <div class="joystickContainer">
                        <canvas id="joystick"></canvas>
                </div>
                <div id="fireBtn">
                        
                </div> 
                <div id="waterBtn">
                        
                </div> 
                <div id="earthBtn">
                        
                </div>                
                <div id="airBtn">
                        
                </div>
                <div id="aBtn" class="abtn">
                        <p class="abtna">A</p>
                </div>                
                <div id="bBtn" class="bbtn">
                        <p class="bbtnb">B</p>
                </div>
                <div class="dev-opts">
                        <button class="dev-btn" id="test1">Test 1</button>
                        <button class="dev-btn" id="test2">Test 2</button>
                </div>
        </div>
        <!-- <p id="test" style="color: cyan; font-size: 30px;">test</p> -->
        <!-- jQuery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

        <!-- <script src="/public/scripts/element/firebase.js"></script> -->
        <!-- <script src="/public/scripts/element/objects.js"></script> -->
        <!-- <script src="/public/scripts/element/element.js"></script> -->
        <!-- <script src="/public/scripts/element/joystick.js"></script> -->
        <!-- <script src="/public/scripts/element/conjure.js"></script> -->
        <!-- <script src="/public/scripts/element/events.js"></script> -->
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script>
                var starBkgnd = new Image();
starBkgnd.src = '/public/images/background.png';

var canvas = document.getElementById('canvas');                 //main canvas
var ctx = canvas.getContext('2d');                              //context of main canvas

//npc/player objects
var boss = new Object(900, 250, 100, 100, 'magenta');                
var player = new Object(20, 480, 20, 20, 'red');
var fireplayer = new Image();
fireplayer.src = "/public/images/fireplayer.png"


//used for drawing weapon type blocks
var border = new Object(canvas.width / 2, 0, 5, 600, 'red');
var weaponType = new Object(40, 620, 70, 70, 'yellow');
var fire = new Object(50, 630, 50, 50, 'red');
var water = new Object(150, 630, 50, 50, 'blue');
var earth = new Object(250, 630, 50, 50, 'rgba(165, 42, 42, 0.6)');
var air = new Object(350, 630, 50, 50, 'white');

//primary elements images
var airimg = new Image();
airimg.src = "/public/images/airimg.png";

var waterimg = new Image();
waterimg.src = "/public/images/waterimg.png";

var earthimg = new Image();
earthimg.src = "/public/images/earthimg.png";

var fireimg = new Image();
fireimg.src = "/public/images/fireimg.png";

//secondary elements images
var meteorimg = new Image();
meteorimg.src = "/public/images/meteor.png";

var lightimg = new Image();
lightimg.src = "/public/images/light.png";

var plantimg = new Image();
plantimg.src = "/public/images/plant.png";

var iceimg = new Image();
iceimg.src = "/public/images/ice.png";

var meteoractive = false;
var lightactive = false;
var iceactve = false;
var plantactive = false;




//when button gets pressed, a new bullet object gets pushed to one of these arrays
var fireball = [];
var waterball = [];
var airball = [];
var earthball = [];


//captures players position to place wall
var wallx = player.x + player.w + 5;
var wally = player.y - 40;


//wall objects
var firewall = new Object(-100, wally, 20, 100, 'red');
var firewallup = false;
var waterwall = new Object(-100, wally, 20, 100, 'blue');
var waterwallup = false;
var earthwall = new Object(-100, wally, 20, 100, 'brown');
var earthwallup = false;
var airwall = new Object(-100, wally, 20, 100, 'white');
var airwallup = false;

//enemy test walls
var efirewall = new Object(700, 50, 20, 100, 'red');
var ewaterwall = new Object(700, 190, 20, 100, 'blue');
var eearthwall = new Object(700, 330, 20, 100, 'brown');
var eairwall = new Object(700, 470, 20, 100, 'white');

//element your currently on
var fireActive = true;
var waterActive = false;
var earthActive = false;
var airActive = false;

//your speed
var playerspeed = 10;
// var bossSpeed = 1;

//your direction
var left = false;
var right = false;
var up = false;
var down = false;
                var pid = Math.random();

                var socket = io();

                var devbtn1 = document.getElementById('test1');
                var devbtn2 = document.getElementById('test2');

                devbtn1.addEventListener('click', function() {                       
                        socket.emit('messagefromcli', {
                                message: 'From client: Clients id is ' + pid,
                        })
                })

                //server start
                socket.on('newPosition', function(data) {
                        ctx.drawImage(starBkgnd, 0,  0, canvas.width, canvas.height);
                        for(var i = 0; i < data.length; i++) {
                                ctx.drawImage(fireplayer, data[i].x, data[i].y, 150, 125);
                        }
                })
                
                document.addEventListener('keydown', keyPress);
                document.addEventListener('keyup', keyLift);
                //KEYBOARD MOVEMENT
                function keyPress(evt) {
                        switch (evt.keyCode) {
                                case 38:
                                socket.emit('movement', {
                                        up: true,
                                })
                                break;
                                case 37:
                                // left = true;
                                socket.emit('movement', {
                                        left: true,
                                })
                                break;
                                case 39:
                                socket.emit('movement', {
                                        right: true,
                                })
                                break;
                                case 40:
                                socket.emit('movement', {
                                        down: true,
                                })
                                break;
                        }
                }
                function keyLift(evt) {
                        switch (evt.keyCode) {
                                case 38:
                                socket.emit('movement', {
                                        up: false,
                                })
                                break;
                                case 37:
                                // left = false;
                                socket.emit('movement', {
                                        left: false,
                                })
                                break;
                                case 39:
                                socket.emit('movement', {
                                        right: false,
                                })
                                break;
                                case 40:
                                socket.emit('movement', {
                                        down: false,
                                })
                                break;
                        }
                }

var pad = document.getElementById('joystick');
pad.width = 350;
pad.height = 350;
var jctx = pad.getContext('2d');
var rect = pad.getBoundingClientRect();

// var stats = document.getElementById('stats');

jctx.fillStyle = 'black';
jctx.fillRect(116, 0, 10, pad.height);
jctx.fillRect(233, 0, 10, pad.height);

jctx.fillRect(0, 116, pad.width, 10);
jctx.fillRect(0, 233, pad.width, 10);

jctx.fillRect(116, 116, 117, 117)

var cX = Math.floor(pad.width / 2);
var cY = Math.floor(pad.height / 2);

var xPos;
var yPox;
var des;
var dist;

// pad.addEventListener('touchstart', function(e) {
    
// })
var initialX;
var initialY;


function getMousePos(pad, mouseEvent) {
    // playerInfo.child('player1').child('position').set({
    //     x: player.x,
    //     y: player.y
    // })
    // console.log(playerInfo);
    var rect = pad.getBoundingClientRect();

    initialX = mouseEvent.touches[0].clientX - 80;
    initialY = mouseEvent.touches[0].clientY - 800;

    if(mouseEvent.touches.length === 1) {
        initialX = mouseEvent.touches[0].clientX - 80;
        initialY = mouseEvent.touches[0].clientY - 800;
    }  else if(mouseEvent.touches.length > 1) {
        initialX = mouseEvent.touches[1].clientX - 80;
        initialY = mouseEvent.touches[1].clientY - 800;
        if(initialX > 350 || initialY > 350 || initialX < 0 || initialY < 0) {
            initialX = mouseEvent.touches[0].clientX - 80;
            initialY = mouseEvent.touches[0].clientY - 800;
        }
    }

    console.log('moust event touches --- ' + mouseEvent.touches.length);
    
    if(mouseEvent.touches.length === 1) {
        // stats.innerText = `One press~~~touches[0].x,y = ${Math.round(mouseEvent.touches[0].clientX - 80)},${Math.round(mouseEvent.touches[0].clientY - 80)}`;
        return {
          x: mouseEvent.touches[0].clientX - 80,
          y: mouseEvent.touches[0].clientY - 800
        };       
    } else if(mouseEvent.touches.length > 1) {
        // stats.innerText = `TWO presses!!!~~~touches[1].x,y = ${Math.round(mouseEvent.touches[1].clientX - 80)},${Math.round(mouseEvent.touches[1].clientY - 80)} else | ${Math.round(mouseEvent.touches[0].clientX - 80)},${Math.round(mouseEvent.touches[0].clientY - 80)}`;
        return {
            x: mouseEvent.touches[1].clientX - 80,
            y: mouseEvent.touches[1].clientY - 800
          };
    }
}

var interval;
pad.addEventListener("touchmove", function(e) {
    e.preventDefault();
    e.stopPropagation();
                       
        var m = getMousePos(pad, e);
        
        if (m.x < cX) {
          if (m.y < cY) pos = 180 + Math.floor(Math.atan((m.y - cY) / (cX - m.x)) * (180 / Math.PI));
          else pos = 180 + -Math.floor(Math.atan((m.y - cY) / (m.x - cX)) * (180 / Math.PI));
        } else {
          if (m.y < cY) pos = - Math.floor(Math.atan((cY - m.y) / (cX - m.x)) * (180 / Math.PI)) ;
          else pos = 360 + Math.floor(Math.atan((cY - m.y) / (m.x - cX)) * (180 / Math.PI));
        }
      
        // get the distance from the centre
        tX = Math.abs(cX - m.x);
        tY = Math.abs(cY - m.y);
        tD = Math.floor(Math.sqrt(tX * tX + tY * tY));
        console.log(`
X:          ${m.x}  
Y:          ${m.y}
Degrees:    ${pos}
Distance:   ${tD}px ${cX} 30
                    `)
        xPos = m.x - 20;
        yPos = m.y - 80;
        deg = pos;
        dist = tD;

    joystickrender()

    //upper left
    if(initialX < 116 && initialY < 116 && initialY) {
        socket.emit('movement', {
                left: true,
                up: true,
                down: false,
                right: false
        })
    }

    //center left
    if(initialX < 116 && initialY > 116 && initialY < 233) {
        socket.emit('movement', {
                left: true,
                up: false,
                down: false,
                right: false
        })
    }
    // bottom left
    if(initialY > 233 && initialX < 116) {
        socket.emit('movement', {
                left: true,
                up: false,
                down: true,
                right: false
        })
    }
    //bottom center;
    if(initialX > 116 && initialX < 233 && initialY > 266) {
        socket.emit('movement', {
                left: false,
                up: false,
                down: true,
                right: false
        })
    }
    //bottom right
    if(initialX > 266 && initialY > 266 && initialX < 350 && initialY < 350) {
        socket.emit('movement', {
                left: false,
                up: false,
                down: true,
                right: true
        })
    }
    //right center
    if(initialX > 266 && initialY > 116 && initialY < 266) {
        socket.emit('movement', {
                left: false,
                up: false,
                down: false,
                right: true
        })
    }
    //upper right
    if(initialX > 266 && initialY < 116) {
        socket.emit('movement', {
                left: false,
                up: true,
                down: false,
                right: true
        })
    }
    //top center 
    if(initialX > 133 && initialX < 266 && initialY < 116) {
        socket.emit('movement', {
                left: false,
                up: true,
                down: false,
                right: false
        })
    }
        

  }, false);

function joystickrender() {
    console.log(initialX, initialY)

    jctx.fillStyle = 'lime',
    jctx.fillRect(0, 0, pad.width, pad.height);
    jctx.fillStyle = 'black';
    jctx.fillRect(116, 0, 10, pad.height);
    jctx.fillRect(233, 0, 10, pad.height);
    jctx.fillRect(116, 116, 117, 117)

    jctx.fillRect(0, 116, pad.width, 10);
    jctx.fillRect(0, 233, pad.width, 10);

    jctx.fillStyle = 'black',
    // jctx.fillRect(pad.width/2 - 7.5, pad.height/2 - 7.5, 15, 15);
    jctx.fillRect(initialX, initialY, 15, 15);
}

pad.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    var m = getMousePos(pad, e);
        
    if (m.x < cX) {
      if (m.y < cY) pos = 180 + Math.floor(Math.atan((m.y - cY) / (cX - m.x)) * (180 / Math.PI));
      else pos = 180 + -Math.floor(Math.atan((m.y - cY) / (m.x - cX)) * (180 / Math.PI));
    } else {
      if (m.y < cY) pos = - Math.floor(Math.atan((cY - m.y) / (cX - m.x)) * (180 / Math.PI)) ;
      else pos = 360 + Math.floor(Math.atan((cY - m.y) / (m.x - cX)) * (180 / Math.PI));
    }
  
    // get the distance from the centre
    tX = Math.abs(cX - m.x);
    tY = Math.abs(cY - m.y);
    tD = Math.floor(Math.sqrt(tX * tX + tY * tY));
    xPos = m.x - 20;
    yPos = m.y - 80;
    deg = pos;
    dist = tD;

    //upper left
    if(initialX < 116 && initialY < 116 && initialY) {
        socket.emit('movement', {
                left: true,
                up: true,
                down: false,
                right: false
        })
    }

    //center left
    if(initialX < 116 && initialY > 116 && initialY < 233) {
        socket.emit('movement', {
                left: true,
                up: false,
                down: false,
                right: false
        })
    }
    // bottom left
    if(initialY > 233 && initialX < 116) {
        socket.emit('movement', {
                left: true,
                up: false,
                down: true,
                right: false
        })
    }
    //bottom center;
    if(initialX > 116 && initialX < 233 && initialY > 266) {
        socket.emit('movement', {
                left: false,
                up: false,
                down: true,
                right: false
        })
    }
    //bottom right
    if(initialX > 266 && initialY > 266 && initialX < 350 && initialY < 350) {
        socket.emit('movement', {
                left: false,
                up: false,
                down: true,
                right: true
        })
    }
    //right center
    if(initialX > 266 && initialY > 116 && initialY < 266) {
        socket.emit('movement', {
                left: false,
                up: false,
                down: false,
                right: true
        })
    }
    //upper right
    if(initialX > 266 && initialY < 116) {
        socket.emit('movement', {
                left: false,
                up: true,
                down: false,
                right: true
        })
    }
    //top center 
    if(initialX > 133 && initialX < 266 && initialY < 116) {
        socket.emit('movement', {
                left: false,
                up: true,
                down: false,
                right: false
        })
    }
        
    joystickrender()
})

pad.addEventListener('touchend', function(e) {
    e.preventDefault();
    socket.emit('movement', {
                left: false,
                up: false,
                down: false,
                right: false
        })
})
        </script>
</body>

</html>